<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<CompositionRulesConfiguration TargetServiceID="CloudService">
    <MetricsCompositionRules>
       <CompositionRule TargetMonitoredElementLevel="VM">
            <ResultingMetric measurementUnit="" name="iAmOne"/>
            <Operation value="1" type="SET_VALUE"/>
        </CompositionRule>
   
       <CompositionRule TargetMonitoredElementLevel="SERVICE_UNIT">
           <TargetMonitoredElementID>LoadBalancer</TargetMonitoredElementID>
           <ResultingMetric name="currentActiveClients" measurementUnit="count"/>
           <Operation type="AVG" MetricSourceMonitoredElementLevel="VM">
              <ReferenceMetric name="activeConnections" measurementUnit="no"/>
           </Operation>  
       </CompositionRule>
       <CompositionRule TargetMonitoredElementLevel="SERVICE_UNIT">
           <TargetMonitoredElementID>EventProcessing</TargetMonitoredElementID>
           <ResultingMetric name="avgResponseTime" measurementUnit="ms"/>
           <Operation type="AVG" MetricSourceMonitoredElementLevel="VM">
              <ReferenceMetric name="responseTime" measurementUnit="ms"/>
           </Operation>  
       </CompositionRule>

       <CompositionRule TargetMonitoredElementLevel="SERVICE_TOPOLOGY">
            <TargetMonitoredElementID>DataEnd</TargetMonitoredElementID>
            <ResultingMetric type="RESOURCE" measurementUnit="%" name="cpuUsage"/>
            <Operation value="100" type="ADD">
                <Operation value="-1" type="MUL">
                    <Operation MetricSourceMonitoredElementLevel="VM" type="AVG">
                        <ReferenceMetric type="RESOURCE" measurementUnit="%" name="cpu_idle"/>
                    </Operation>
                </Operation>
            </Operation>
        </CompositionRule>

         <CompositionRule TargetMonitoredElementLevel="SERVICE_UNIT">
            <TargetMonitoredElementID>EventProcessing</TargetMonitoredElementID>
            <ResultingMetric type="RESOURCE" measurementUnit="operations/s" name="throughput"/>
            <Operation MetricSourceMonitoredElementLevel="VM" type="SUM">
                <ReferenceMetric type="RESOURCE" measurementUnit="" name="throughput"/>
            </Operation>
        </CompositionRule>
        
        <CompositionRule TargetMonitoredElementLevel="SERVICE_UNIT">
            <ResultingMetric type="RESOURCE" measurementUnit="count" name="numberOfVMs"/>
            <Operation MetricSourceMonitoredElementLevel="VM" type="SUM">
                <ReferenceMetric type="RESOURCE" measurementUnit="" name="iAmOne"/>
            </Operation>
        </CompositionRule>

       <CompositionRule TargetMonitoredElementLevel="SERVICE_UNIT">
            <ResultingMetric type="RESOURCE" measurementUnit="$" name="cost"/>
            <Operation MetricSourceMonitoredElementLevel="SERVICE_UNIT" value="0.12" type="MUL">
                <ReferenceMetric type="RESOURCE" measurementUnit="" name="numberOfVMs"/>
            </Operation>
        </CompositionRule>

        <CompositionRule TargetMonitoredElementLevel="SERVICE">
            <ResultingMetric type="RESOURCE" measurementUnit="$" name="cost/client/h"/>
            <Operation type="DIV">
                <Operation MetricSourceMonitoredElementLevel="SERVICE_UNIT" type="SUM">
                    <ReferenceMetric type="RESOURCE" measurementUnit="" name="cost"/>
                </Operation>
                <Operation MetricSourceMonitoredElementLevel="SERVICE_UNIT" type="KEEP">
                    <ReferenceMetric type="RESOURCE" measurementUnit="" name="currentActiveClients"/>
                    <SourceMonitoredElementID>LoadBalancer</SourceMonitoredElementID>
                </Operation>
            </Operation>
        </CompositionRule>


    </MetricsCompositionRules>
</CompositionRulesConfiguration>
